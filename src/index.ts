import fastify from 'fastify'
import { schema } from './schema'
import { 
  getGraphQLParameters, 
  processRequest, 
  renderGraphiQL, 
  sendResult, 
  shouldRenderGraphiQL, 
} from 'graphql-helix'

const app = fastify()

app.route({
  method: ['GET', 'POST'],
  url: '/graphql',
  async handler(req, res) {
    const request = {
      body: req.body,
      headers: req.headers,
      method: req.method,
      query: req.query,
    }

    if (shouldRenderGraphiQL(request)) {
      res.type('text/html')
      res.send(renderGraphiQL({}))
    } else {
      const request = {
        body: req.body,
        headers: req.headers,
        method: req.method,
        query: req.query,
      }
      const {
        operationName,
        query,
        variables,
      } = getGraphQLParameters(request)
      const result = await processRequest({
        operationName,
        query,
        variables,
        request,
        schema,
      })

      sendResult(result, res.raw)
    }
  },
})

const port = process.env.PORT || 4000

app.listen(port, () => {
  console.log(`GraphQL server is running on port ${port}.`)
})
